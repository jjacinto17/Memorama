<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memorama</title>
    <style>
        canvas {
            border: 3px black solid;
            background: blue;
            display: block;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
        }

        body {
            width: 950px;
            margin: 0 auto;
        }

        #modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        #modal-content {
            background-color: #fefefe;
            padding: 20px;
            text-align: center;
        }

        #modal-content button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
        }
    </style>
</head>

<body>
    <h1>MemoramaTumbado</h1>
    <canvas id="canvas" width="950" height="670"></canvas>
    <div id="modal">
        <div id="modal-content">
            <h2>Selecciona un modo de juego:</h2>
            <button onclick="iniciarJuego(15 * 60)">Fácil (15 minutos)</button>
            <button onclick="iniciarJuego(10 * 60)">Normal (10 minutos)</button>
            <button onclick="iniciarJuego(5 * 60)">Difícil (5 minutos)</button>
        </div>
    </div>
    <script>
        var canvas = document.getElementById("canvas");
        var ctx = canvas.getContext("2d");
        var modal = document.getElementById("modal");

        // Variables-Carta
        var colorDelante = "green";
        var colorAtras = "red";
        var cartaMargen = 10;
        var cartaLongitud = 100;
        var cartaAncho = cartaLongitud;
        var cartaLargo = cartaLongitud;
        var numerosCartas = [];
        var cartas_array = [];
        var modalVisible = true;
        var tiempoLimite = 0;
        var tiempoInicio = 0;
        var tiempoRestante = 0;

        var numerosUnicos = [];

        for (var i = 0; i < 14; i++) {
            var numeroCarta = obtenerNumeroAleatorio();
            if (numeroCarta !== undefined) {
                numerosCartas.push(numeroCarta);
                numerosCartas.push(numeroCarta);
            }
        }
        // Duplicar los números para tener 15 pares
        var numerosCartas = numerosUnicos.concat(numerosUnicos);

        // Barajar los números
        for (var j = numerosCartas.length - 1; j > 0; j--) {
            var k = Math.floor(Math.random() * (j + 1));
            var temp = numerosCartas[j];
            numerosCartas[j] = numerosCartas[k];
            numerosCartas[k] = temp;
        }


        function dibujarModal() {
            ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);


        }

        function iniciarJuego(tiempo) {
            modal.style.display = "none";
            modalVisible = false;
            tiempoLimite = tiempo;
            tiempoInicio = Date.now();
            tiempoRestante = tiempoLimite;
        }

        function dibujarTiempo() {
            ctx.font = "bold 20px Arial";
            ctx.fillStyle = "white";
            var minutos = Math.floor(tiempoRestante / 60);
            var segundos = Math.floor(tiempoRestante % 60);
            var tiempoFormateado = minutos.toString().padStart(2, '0') + ":" + segundos.toString().padStart(2, '0');
            ctx.fillText("Tiempo restante: " + tiempoFormateado, canvas.width - 250, 30);
        }

        function formatearTiempo(segundos) {
            var minutos = Math.floor(segundos / 60);
            var segundosRestantes = segundos % 60;

            var tiempoFormateado = minutos.toString().padStart(2, '0') + ":" + segundosRestantes.toString().padStart(2, '0');

            return tiempoFormateado;
        }

        // Contador de cartas emparejadas
        var cartasEmparejadas = 0;

        // Cartas seleccionadas
        var cartasSeleccionadas = [];

        // Dar vuelta a cartas que no coinciden
        var contadorEspera = 0;
        var tiempoEspera = 20;

        // Dar números únicos para las cartas
        for (var i = 0; i < 15; i++) {
            numerosCartas.push(i);
            numerosCartas.push(i);
        }

        function obtenerNumeroAleatorio() {
            if (numerosCartas.length === 0) {
                return undefined; // No quedan números únicos disponibles
            }
            var indice = Math.floor(Math.random() * numerosCartas.length);
            return numerosCartas.splice(indice, 1)[0];
        }

        function Carta(x, y, ancho, largo, numero) {
            this.x = x;
            this.y = y;
            this.ancho = ancho;
            this.largo = largo;
            this.numero = numero;
            this.volteada = false;
            this.rutaImagen = `Cartas_img/carta${numero}.jpg`; // Almacenar la ruta de la imagen
            this.imagen = new Image();
            this.imagen.src = this.rutaImagen; // Cargar la imagen correspondiente

            this.dibuja = dibujaCarta;
        }

        function dibujaCarta() {
            if (this.volteada) {
                ctx.drawImage(this.imagen, this.x, this.y, this.ancho, this.largo);
            } else {
                ctx.fillStyle = colorAtras;
                ctx.fillRect(this.x, this.y, this.ancho, this.largo);
            }
        }
        function tablero() {
            var numColumnas = 5;
            var numFilas = 6;
            var espacioHorizontal = cartaAncho + cartaMargen;
            var espacioVertical = cartaLargo + cartaMargen;

            for (var fila = 0; fila < numFilas; fila++) {
                for (var columna = 0; columna < numColumnas; columna++) {
                    var numeroCarta = obtenerNumeroAleatorio();
                    var x = columna * espacioHorizontal + cartaMargen;
                    var y = fila * espacioVertical + cartaMargen;
                    var carta = new Carta(x, y, cartaAncho, cartaLargo, numeroCarta);
                    cartas_array.push(carta);
                    carta.dibuja();
                }
            }
        }

        function barajear() {
            var i, j, k;
            var temporal;
            var lon = cartas_array.length;

            for (j = 0; j < lon * 4; j++) {
                i = Math.floor(Math.random() * lon);
                k = Math.floor(Math.random() * lon);

                temporal = cartas_array[i].numero;

                cartas_array[i].numero = cartas_array[k].numero;
                cartas_array[k].numero = temporal;
            }
        }

        function verificarCartasIguales() {
            if (cartasSeleccionadas.length === 2) {
                var primeraCarta = cartas_array[cartasSeleccionadas[0]];
                var segundaCarta = cartas_array[cartasSeleccionadas[1]];

                if (primeraCarta.rutaImagen === segundaCarta.rutaImagen) {
                    // Las imágenes son iguales, se ha encontrado un par correcto
                    cartasEmparejadas += 2;
                    if (cartasEmparejadas === cartas_array.length) {
                        alert("¡Has ganado!");
                        reiniciar();
                    }
                    cartasSeleccionadas.length = 0;
                } else {
                    // Las imágenes no son iguales, voltear las cartas nuevamente
                    voltearCartas();
                }
            }
        }

        function reiniciar() {
            modal.style.display = "block";
            modalVisible = true;
            tiempoLimite = 0;
            tiempoInicio = 0;
            tiempoRestante = 0;
            cartas_array.length = 0;
            cartasEmparejadas = 0;
            cartasSeleccionadas.length = 0;
            contadorEspera = 0;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Restaurar la lista de números únicos
            numerosCartas = [];
            for (var i = 0; i < 14; i++) {
                var numeroCarta = obtenerNumeroAleatorio();
                if (numeroCarta !== undefined) {
                    numerosCartas.push(numeroCarta);
                    numerosCartas.push(numeroCarta);
                }
            }

            // Duplicar los números para tener 15 pares
            numerosCartas = numerosCartas.concat(numerosCartas);

            // Barajar los números
            for (var j = numerosCartas.length - 1; j > 0; j--) {
                var k = Math.floor(Math.random() * (j + 1));
                var temp = numerosCartas[j];
                numerosCartas[j] = numerosCartas[k];
                numerosCartas[k] = temp;
            }

            // Cargar las imágenes nuevamente
            imagenesCargadas = 0;
            totalImagenes = numerosCartas.length;

            for (var i = 0; i < totalImagenes; i++) {
                var carta = new Carta(0, 0, cartaAncho, cartaLargo, numerosCartas[i]);
                carta.imagen.onload = function () {
                    imagenesCargadas++;
                    if (imagenesCargadas === totalImagenes) {
                        // Todas las imágenes han cargado, iniciar el juego
                        tablero();
                        barajear();
                    }
                };
            }
        }

        function voltearCartas() {
            setTimeout(function () {
                cartasSeleccionadas.forEach(function (indice) {
                    cartas_array[indice].volteada = false;
                });
                cartasSeleccionadas.length = 0;
            }, 1000);
        }

        canvas.addEventListener("mousedown", seleccionarCarta, false);

        // Obtiene la carta seleccionada
        function seleccionarCarta(e) {
            var posicion = ajusta(e.clientX, e.clientY);

            for (var i = 0; i < cartas_array.length; i++) {
                var carta = cartas_array[i];

                if (!carta.volteada && cartasSeleccionadas.length < 2 &&
                    (posicion.x > carta.x) && (posicion.x < carta.x + carta.ancho)
                    && (posicion.y > carta.y) && (posicion.y < carta.y + carta.largo)) {
                    carta.volteada = true;
                    carta.dibuja();
                    cartasSeleccionadas.push(i);
                    verificarCartasIguales(); // Verificar si las cartas son iguales
                    break;
                }
            }
        }


        // Obtiene la posición del canvas
        function ajusta(xx, yy) {
            var posicionCanvas = canvas.getBoundingClientRect();
            var x = xx - posicionCanvas.left;
            var y = yy - posicionCanvas.top;
            return { x: x, y: y }
        }

        // Limpia el canvas y dibuja todas las cartas
        function limpiarCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (var i = 0; i < cartas_array.length; i++) {
                cartas_array[i].dibuja();
            }
        }

        const update = () => {
            limpiarCanvas();
            if (contadorEspera > 0) {
                contadorEspera--;
                if (contadorEspera === 0) {
                    // Voltear cartas
                    cartasSeleccionadas.forEach(function (indice) {
                        cartas_array[indice].volteada = false;
                    });
                    cartasSeleccionadas.length = 0;
                }
            }
            // Verificar el tiempo límite
            if (!modalVisible) {
                var currentTime = Date.now();
                var elapsedTime = (currentTime - tiempoInicio) / 1000;
                tiempoRestante = tiempoLimite - elapsedTime;
                if (elapsedTime >= tiempoLimite) {
                    alert("¡Tiempo agotado! Reiniciando el juego.");
                    reiniciar();
                }
            }

            dibujarTiempo();
            requestAnimationFrame(update);
        }

        var imagenesCargadas = 0;
        var totalImagenes = numerosCartas.length;

        for (var i = 0; i < totalImagenes; i++) {
            var carta = new Carta(0, 0, cartaAncho, cartaLargo, numerosCartas[i]);
            carta.imagen.onload = function () {
                imagenesCargadas++;
                if (imagenesCargadas === totalImagenes) {
                    // Todas las imágenes han cargado, iniciar el juego
                    tablero();
                    barajear();
                    requestAnimationFrame(update);
                }
            };
        }

    </script>
</body>

</html>