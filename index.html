<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memorama</title>
    <style>
        canvas {
            border: 3px black solid;
            background: blue;
        }

        h1 {
            text-align: center;
        }

        body {
            width: 1000px;
            margin: 0% auto;
        }
    </style>
</head>

<body>

    <h1>Memorama</h1>

    <canvas id="canvas" width="1000" height="640"></canvas>

    <script>
        var canvas = document.getElementById("canvas");
        var ctx = canvas.getContext("2d");

        // Variables-Carta
        var colorDelante = "green";
        var colorAtras = "red";
        var inicioX = 45;
        var inicioY = 50;
        var cartaMargen = 20;
        var cartaLongitud = 30;
        var cartaAncho = cartaLongitud * 4;
        var cartaLargo = cartaLongitud * 4;
        var numerosCartas = [];
        var cartas_array = [];

        // Contador de cartas emparejadas
        var cartasEmparejadas = 0;

        // Cartas seleccionadas
        var cartasSeleccionadas = [];

        // Dar vuelta a cartas que no coinciden
        var contadorEspera = 0;
        var tiempoEspera = 20;

        // Dar numeros unicos para las cartas
        for (var i = 0; i < 8; i++) {
            numerosCartas.push(i);
            numerosCartas.push(i);
        }


        function obtenerNumeroAleatorio() {
            var indice = Math.floor(Math.random() * numerosCartas.length);
            return numerosCartas.splice(indice, 1)[0];
        }

        // Crear carta
        function Carta(x, y, ancho, largo, numero) {
            this.x = x;
            this.y = y;
            this.ancho = ancho;
            this.largo = largo;
            this.numero = numero;
            this.volteada = false;
            this.dibuja = dibujaCarta;
        }

        function dibujaCarta() {
            if (this.volteada) {
                ctx.fillStyle = colorDelante;
                ctx.fillRect(this.x, this.y, this.ancho, this.largo);
                ctx.font = "bold 40px Arial";
                ctx.fillStyle = "black";
                ctx.fillText(String(this.numero),
                    this.x + this.ancho / 2 - 10, this.y + this.largo / 2 + 10);
            } else {
                ctx.fillStyle = colorAtras;
                ctx.fillRect(this.x, this.y, this.ancho, this.largo);
            }
        }

        function tablero() {
            var x = inicioX;
            var y = inicioY;

            for (var i = 0; i < 16; i++) {
                var numeroCarta = obtenerNumeroAleatorio();
                var carta = new Carta(x, y, cartaAncho, cartaLargo, numeroCarta);
                cartas_array.push(carta);
                carta.dibuja();
                x += cartaAncho + cartaMargen;
                if (i % 4 == 3) {
                    x = inicioX;
                    y += cartaLargo + cartaMargen;
                }
            }
        }

        function barajear() {
            var i, j, k;
            var temporal;
            var lon = cartas_array.length;

            for (j = 0; j < lon * 4; j++) {
                i = Math.floor(Math.random() * lon);
                k = Math.floor(Math.random() * lon);

                temporal = cartas_array[i].numero;

                cartas_array[i].numero = cartas_array[k].numero;
                cartas_array[k].numero = temporal;
            }
        }

        function reiniciar() {
            numerosCartas = [];
            for (var i = 0; i < 8; i++) {
                numerosCartas.push(i);
                numerosCartas.push(i);
            }
            cartas_array.length = 0;
            cartasEmparejadas = 0;
            cartasSeleccionadas.length = 0;
            contadorEspera = 0;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            tablero();
            barajear();
        }

        function voltearCartas() {
            setTimeout(function () {
                cartasSeleccionadas.forEach(function (indice) {
                    cartas_array[indice].volteada = false;
                });
                cartasSeleccionadas.length = 0;
            }, 1000);
        }

        canvas.addEventListener("mousedown", seleccionarCarta, false);

        // Obtiene la carta seleccionada
        function seleccionarCarta(e) {
            var posicion = ajusta(e.clientX, e.clientY);

            for (var i = 0; i < cartas_array.length; i++) {
                var carta = cartas_array[i];

                if (!carta.volteada && cartasSeleccionadas.length < 2 &&
                    (posicion.x > carta.x) && (posicion.x < carta.x + carta.ancho)
                    && (posicion.y > carta.y) && (posicion.y < carta.y + carta.largo)) {
                    carta.volteada = true;
                    carta.dibuja();
                    cartasSeleccionadas.push(i);

                    if (cartasSeleccionadas.length === 2) {
                        if (cartas_array[cartasSeleccionadas[0]].numero === cartas_array[cartasSeleccionadas[1]].numero) {
                            cartasEmparejadas += 2;
                            if (cartasEmparejadas === cartas_array.length) {
                                alert("¡Has ganado!");
                                reiniciar();
                            }
                            cartasSeleccionadas.length = 0;
                        } else {
                            contadorEspera = tiempoEspera;
                        }
                    }
                    break;
                }
            }
        }

        // Obtiene la posición del canvas
        function ajusta(xx, yy) {
            var posicionCanvas = canvas.getBoundingClientRect();
            var x = xx - posicionCanvas.left;
            var y = yy - posicionCanvas.top;
            return { x: x, y: y }
        }

        // Limpia el canvas y dibuja todas las cartas
        function limpiarCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (var i = 0; i < cartas_array.length; i++) {
                cartas_array[i].dibuja();
            }
        }

        const update = () => {
            limpiarCanvas();
            if (contadorEspera > 0) {
                contadorEspera--;
                if (contadorEspera === 0) {
                    // Voltear cartas
                    cartasSeleccionadas.forEach(function (indice) {
                        cartas_array[indice].volteada = false;
                    });
                    cartasSeleccionadas.length = 0;
                }
            }
            requestAnimationFrame(update);
        }

        tablero();
        barajear();
        requestAnimationFrame(update);

    </script>

</body>

</html>